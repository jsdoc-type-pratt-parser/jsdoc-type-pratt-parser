<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Parser tester</title>
    <script src="lib/jsdoc-type-pratt-parser/index.umd.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
          integrity="sha384-B0vP5xmATw1+K9KRQjQERJvTumQW0nPEzvF6L/Z6nronJ3oUOFUFpCjEUQouq2+l" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"
            integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj"
            crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"
            integrity="sha384-Piv4xVNRyMGpqkS2by6br4gNJ7DXjqk09RmUpJ8jgGtD7zP9yug3goQfGII0yAns"
            crossorigin="anonymous"></script>
    <style>
        #output {
            height: 25em;
        }
        #stringified {
          height: 7em;
        }

        textarea {
            font-family: monospace;
        }

        /* Style the JSDoc tag name */
        .token.parameter {
          color: green;
        }

        /* prism's stylesheet, by styling pre only, doesn't cover all
          code elements (outside of scroll view) */
        code[class*=language-] {
          background-color: #f5f2f0 !important;
        }
    </style>
    <script type="importmap">
      {
        "imports": {
          "prismjs/themes/prism.min.css": "./vendor/prismjs/themes/prism.min.css",
          "@webcoder49/code-input": "./vendor/@webcoder49/code-input/esm/code-input.mjs",
          "@webcoder49/code-input/plugins/indent.mjs": "./vendor/@webcoder49/code-input/esm/plugins/indent.mjs",
          "@webcoder49/code-input/code-input.min.css": "./vendor/@webcoder49/code-input/code-input.min.css"
        }
      }
    </script>

    <!-- Toward getting ESM instead: https://github.com/PrismJS/prism/pull/3704 -->
    <!-- Toward getting better ESM: https://github.com/WebCoder49/code-input/issues/190 -->
    <script src="./vendor/prismjs/components/prism-core.js" data-manual></script><!--Remove data-manual if also using Prism normally-->
    <script src="./vendor/prismjs/plugins/autoloader/prism-autoloader.min.js"></script>
</head>
<body>
<div class="container">
    <div class="row">
        <div class="col-12">
            <h1>JSDoc Type Pratt Parser Tester</h1>
        </div>
    </div>
    <div class="row">
        <div class="col-6">
            <div class="form-group">
                <label for="mode" class="form-label">Type Syntax</label>
                <select id="mode" class="form-control">
                    <option value="closure">Google Closure</option>
                    <option value="jsdoc">JSDoc</option>
                    <option value="typescript" selected>TypeScript</option>
                </select>
            </div>
            <div class="form-group">
                <label for="compatMode" class="form-label">Compatibility Mode</label>
                <select id="compatMode" class="form-control">
                    <option value="native" selected>Native</option>
                    <option value="catharsis">Catharsis</option>
                    <option value="jtp">jsdoctypeparser</option>
                </select>
            </div>
            <div class="form-group">
                <label for="parsingType" class="form-label">Parsing type</label>
                <select id="parsingType" class="form-control">
                    <option value="type" selected>Type</option>
                    <option value="name">Name</option>
                    <option value="namepath">Namepath</option>
                </select>
            </div>
            <div class="form-group">
                <label for="input" class="form-label">Type Expression</label>
                <code-input language="typescript"><textarea id="input" class="form-control" data-code-input-fallback>{[key: string]: [abc?, string, () => void]}</textarea></code-input>
            </div>
            <button id="parse" class="btn btn-primary">Parse</button>
        </div>
        <div class="col-6">
            <div class="form-group">
                <label for="output" class="form-label">Parsed</label>
                <code-input language="json"><textarea id="output" class="form-control" data-code-input-fallback></textarea></code-input>
            </div>

            <div class="form-group">
                <label for="stringified" class="form-label">Stringified</label>
                <code-input language="typescript"><textarea id="stringified" class="form-control" data-code-input-fallback></textarea></code-input>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import {registerTemplate, Template} from '@webcoder49/code-input'

    import Indent from '@webcoder49/code-input/plugins/indent.mjs'

    import prismStyles from 'prismjs/themes/prism.min.css' with {type: 'css'}

    import codeInputStyles from
      '@webcoder49/code-input/code-input.min.css' with {type: 'css'}

    document.adoptedStyleSheets = [prismStyles, codeInputStyles]

    registerTemplate(
      'syntax-highlighted',
      new Template(Prism.highlightElement, false, true, false, [new Indent()])
    )

    const modeSelect = document.querySelector('#mode')
    const compatModeSelect = document.querySelector('#compatMode')
    const parsingTypeSelect = document.querySelector('#parsingType')
    const input = document.querySelector('#input')
    const button = document.querySelector('#parse')
    const output = document.querySelector('#output')
    const stringified = document.querySelector('#stringified')

    function getSelected(select) {
        return Array.from(select.querySelectorAll('option')).find(o => o.selected).value
    }

    output.addEventListener('input', function () {
      const result = JSON.parse(output.value)
      stringified.value = jtpp.stringify(result)
    })

    button.addEventListener('click', function () {
        const mode = getSelected(modeSelect)
        const compatMode = getSelected(compatModeSelect)
        const parsingType = getSelected(parsingTypeSelect)
        try {
            let result = parsingType === 'type'
              ? jtpp.parse(input.value, mode)
              : parsingType === 'name'
                ? jtpp.parseName(input.value, mode)
                : jtpp.parseNamePath(input.value, mode)
            if (compatMode === 'catharsis') {
                result = jtpp.catharsisTransform(result)
            } else if (compatMode === 'jtp') {
                result = jtpp.jtpTransform(result)
            }
            output.value = JSON.stringify(result, null, 2)
            stringified.value = jtpp.stringify(result)
        } catch (e) {
            output.value = e.toString()
        }
    })
</script>
</body>
</html>
